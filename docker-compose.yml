services:
  app:
    container_name: library_laravel_app
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    depends_on:
      - mysql
      - redis
      - rabbitmq
    env_file:
      - .env
    environment:
      - APP_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CART_ENGAGEMENT_COOLDOWN_MINUTES=${CART_ENGAGEMENT_COOLDOWN_MINUTES}
      - ALWAYS_FRESH=${ALWAYS_FRESH}
      - SEED_ON_BOOT=${SEED_ON_BOOT}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "php -v > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  mysql:
    image: mysql:8.0
    container_name: library_laravel_mysql
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=${DB_DATABASE}
      - MYSQL_USER=${DB_USERNAME}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$${MYSQL_ROOT_PASSWORD} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  vite:
    image: node:20-alpine
    container_name: library_laravel_vite
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    command: sh -lc "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "node -v > /dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  redis:
    image: redis:7-alpine
    container_name: library_laravel_redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  mailpit:
    profiles:
      - dev
    image: axllent/mailpit:latest
    container_name: library_laravel_mailpit
    ports:
      - "8025:8025"
      - "1025:1025"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8025"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: library_laravel_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  

  horizon:
    container_name: library_laravel_horizon
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - redis
    env_file:
      - .env
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    environment:
      - APP_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    command: sh -lc "php artisan horizon"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'artisan horizon' | grep -v grep >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  cli:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - redis
      - rabbitmq
    profiles:
      - tools
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    working_dir: /app
    env_file:
      - .env
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - CART_ENGAGEMENT_COOLDOWN_MINUTES=${CART_ENGAGEMENT_COOLDOWN_MINUTES}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST}
      - RABBITMQ_DUE_QUEUE=${RABBITMQ_DUE_QUEUE}
      - RABBITMQ_CART_QUEUE=${RABBITMQ_CART_QUEUE}
    entrypoint: ["sh", "-lc"]
    command: ["php -v"]
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "php -v > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  scheduler:
    container_name: library_laravel_scheduler
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - redis
      - rabbitmq
    env_file:
      - .env
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    environment:
      - APP_ENV=production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - CART_ENGAGEMENT_COOLDOWN_MINUTES=${CART_ENGAGEMENT_COOLDOWN_MINUTES}
    command: sh -lc "php artisan schedule:work"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'artisan schedule:work' | grep -v grep >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app_network

  rabbitmq_due_consumer:
    container_name: library_laravel_rabbitmq_due_consumer
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - rabbitmq
      - redis
    env_file:
      - .env
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    environment:
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - CART_ENGAGEMENT_COOLDOWN_MINUTES=${CART_ENGAGEMENT_COOLDOWN_MINUTES}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST}
      - RABBITMQ_DUE_QUEUE=${RABBITMQ_DUE_QUEUE}
      - RABBITMQ_CART_QUEUE=${RABBITMQ_CART_QUEUE}
    command: sh -lc "until php -r 'exit(@fsockopen(getenv(\"RABBITMQ_HOST\")?:\"rabbitmq\", (int)(getenv(\"RABBITMQ_PORT\")?:5672))?0:1);'; do echo 'waiting for rabbitmq...'; sleep 1; done; php artisan rabbitmq:consume-due"
    restart: unless-stopped
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'rabbitmq:consume-due' | grep -v grep >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq_cart_consumer:
    container_name: library_laravel_rabbitmq_cart_consumer
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - rabbitmq
      - redis
    env_file:
      - .env
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/vendor
    environment:
      - DB_DATABASE=${DB_DATABASE}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - CART_ENGAGEMENT_COOLDOWN_MINUTES=${CART_ENGAGEMENT_COOLDOWN_MINUTES}
      - RABBITMQ_HOST=${RABBITMQ_HOST}
      - RABBITMQ_PORT=${RABBITMQ_PORT}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST}
      - RABBITMQ_DUE_QUEUE=${RABBITMQ_DUE_QUEUE}
      - RABBITMQ_CART_QUEUE=${RABBITMQ_CART_QUEUE}
    command: sh -lc "until php -r 'exit(@fsockopen(getenv(\"RABBITMQ_HOST\")?:\"rabbitmq\", (int)(getenv(\"RABBITMQ_PORT\")?:5672))?0:1);'; do echo 'waiting for rabbitmq...'; sleep 1; done; php artisan rabbitmq:consume-cart"
    restart: unless-stopped
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep 'rabbitmq:consume-cart' | grep -v grep >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: library_laravel_phpmyadmin
    restart: unless-stopped
    depends_on:
      - mysql
    environment:
      - PMA_HOST=mysql
      - PMA_PORT=3306
      - PMA_USER=${DB_USERNAME}
      - PMA_PASSWORD=${DB_PASSWORD}
    ports:
      - "8081:80"
    networks:
      - app_network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80 >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  db_data:

networks:
  app_network:
    driver: bridge
