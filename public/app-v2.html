<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/ddfgsoh5g/image/upload/v1762865952/favicon_kh0lrj.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PedBook - Sua Biblioteca Online</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background-color: #f8fafc; }
        [v-cloak] { display: none; }
        #app { display: flex; flex-direction: column; min-height: 100vh; }
        
        
        header { background-color: #162c74; color: white; padding: 15px 0; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .brand { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .logo { font-size: 1.8rem; }
        .brand h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        
        
        .user-info { display: flex; align-items: center; gap: 15px; color: white; position: relative; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-position: center; border: 2px solid white; cursor: pointer; overflow: hidden; }
        .user-menu-dropdown { position: absolute; top: 50px; right: 0; background: white; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; overflow: hidden; }
        .dropdown-item { display: block; padding: 10px 15px; color: #333; text-decoration: none; border: none; background: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; }
        .dropdown-item:hover { background-color: #f8f9fa; }
        .dropdown-logout { display: block; padding: 10px 15px; color: #dc3545; text-decoration: none; border: none; background: none; width: 100%; text-align: left; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .dropdown-logout:hover { background-color: #fff5f5; }
        
        
        .login-page { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: linear-gradient(135deg, #162c74 0%, #1976d2 100%); min-height: 100vh; }
        .login-box { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); max-width: 400px; width: 100%; }
        .login-box h2 { color: #162c74; margin-bottom: 20px; text-align: center; font-size: 1.6rem; font-weight: 700; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; color: #162c74; font-weight: 600; font-size: 0.9rem; }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #162c74;
            box-shadow: 0 0 0 4px rgba(22, 44, 116, 0.1);
        }
        
        
        .btn { width: 100%; padding: 12px; background: linear-gradient(135deg, #162c74 0%, #1976d2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(22, 44, 116, 0.3); }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; width: auto; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        
        
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin: 20px 0; }
        .book-card { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; position: relative; }
        .book-card:hover { transform: translateY(-5px); }
        .book-card img { width: 100%; height: 250px; object-fit: cover; }
        .book-card-body { padding: 15px; }
        .book-title { font-weight: 700; margin-bottom: 8px; color: #162c74; }
        .book-author { color: #666; font-size: 0.9rem; margin-bottom: 8px; }
        .book-desc { color: #999; font-size: 0.85rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-clamp: 2; }
        .book-card.borrowed { box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.25), 0 2px 8px rgba(0,0,0,0.1); }
        .badge-rented { position: absolute; top: 10px; left: 10px; background: #198754; color: #fff; padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: 0.85rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); z-index: 2; }
        .fav-chip { position: absolute; top: 10px; right: 10px; width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255,255,255,0.95); color: #dc3545; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0,0,0,0.15); z-index: 5; transition: transform 0.15s, background 0.15s, color 0.15s; }
        .fav-chip:hover { transform: scale(1.05); }
        .fav-chip.active { background: #dc3545; color: #fff; }
        .banner-rented { position: absolute; top: 0; left: 0; width: 100%; height: 38px; display: flex; align-items: center; justify-content: center; background: rgba(25, 135, 84, 0.92); color: #fff; font-weight: 800; letter-spacing: .6px; font-size: .95rem; z-index: 4; pointer-events: none; }
        .book-card.borrowed::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 250px; background: rgba(0,0,0,0.35); z-index: 2; pointer-events: none; }
        .book-card.borrowed img { filter: brightness(0.4); }
        .fav-chip-bottom { display: inline-block; margin-top: 8px; background: rgba(220,53,69,0.10); color: #dc3545; padding: 4px 8px; border-radius: 999px; font-weight: 600; font-size: 0.85rem; }
        
        
        .pagination { display: flex; justify-content: center; gap: 10px; margin: 30px 0; }
        .page-link { padding: 8px 16px; background: white; border: 1px solid #dee2e6; border-radius: 4px; color: #162c74; cursor: pointer; transition: all 0.2s; }
        .page-link:hover { background: #f8f9fa; }
        .page-link.active { background: #162c74; color: white; border-color: #162c74; }
        
        
        footer { background: #162c74; color: white; text-align: center; padding: 15px; margin-top: auto; }
        
        
        .text-center { text-align: center; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .error { color: #dc3545; margin-bottom: 15px; padding: 10px; background: #f8d7da; border-radius: 4px; border: 1px solid #f5c6cb; }
        .success { color: #155724; margin-bottom: 15px; padding: 10px; background: #d4edda; border-radius: 4px; border: 1px solid #c3e6cb; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        main { padding-top: 56px; padding-bottom: 72px; }

        
        .stars { display: inline-flex; gap: 6px; font-size: 22px; cursor: pointer; user-select: none; }
        .star { color: #e0e0e0; transition: color .15s ease; }
        .star.active { color: #1976d2; }

        
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin: 20px 0; }
        .user-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(22,44,116,0.22);
        }
        .user-card-cover {
            width: 100%;
            height: 210px;
            background: #f0f2f5;
            overflow: hidden;
        }
        .user-card-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .user-card-body {
            padding: 14px 16px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .user-name { font-weight: 700; color: #162c74; margin-bottom: 4px; }
        .user-card:hover .user-name { color: #1976d2; }
        .user-email { color: #666; font-size: 0.9rem; margin-bottom: 2px; word-break: break-word; }
        .user-role { display: inline-block; padding: 3px 8px; background:#e9ecef; border-radius:12px; font-size:0.8rem; color:#495057; }

        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            overflow-y: auto;
        }
        .modal.active { 
            display: flex; 
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            padding: 0 8px;
        }
        .modal-close:hover {
            color: #333;
        }
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .modal-section {
            margin-bottom: 4px;
            padding: 14px 16px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
        }
        .modal-section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #162c74;
            margin-bottom: 4px;
        }
        .modal-section-helper {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 10px;
        }
        .modal-two-columns {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 4px;
        }
        @media (min-width: 768px) {
            .modal-two-columns {
                flex-direction: row;
            }
            .modal-two-columns > .form-group {
                flex: 1;
                margin-bottom: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        
        <header v-if="currentUser">
            <div class="header-container">
                <div class="brand" @click="goHome">
                    <span class="logo">üìö</span>
                    <h1>PedBook</h1>
                </div>

        
        <div class="modal" :class="{ active: showEditBookModal }" @click.self="showEditBookModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Livro</h3>
                    <button class="modal-close" @click="showEditBookModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveEditBook">
                        <div class="form-group">
                            <label>T√≠tulo:</label>
                            <input type="text" v-model="editBook.title" required>
                        </div>
                        <div class="form-group">
                            <label>Autor:</label>
                            <select v-model="editBook.author_id" required>
                                <option v-for="author in authors" :key="author.id" :value="author.id">{{ author.name }}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descri√ß√£o:</label>
                            <textarea v-model="editBook.description" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Foto (URL ou Cloudinary publicId):</label>
                            <input type="text" v-model="editBook.photo" required>
                            <div class="mt-3">
                                <button type="button" class="btn btn-small" @click="openUpload('book_edit')">Upload</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>

        
        <div class="modal" :class="{ active: showRentModal }" @click.self="showRentModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Alugar Livro</h3>
                    <button class="modal-close" @click="showRentModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <div v-if="rentTargetBook">
                        <p style="margin-bottom:10px;">Livro: <strong>{{ rentTargetBook.title }}</strong></p>
                        <div class="form-group">
                            <label>Data de devolu√ß√£o:</label>
                            <input type="date" v-model="rentReturnDate" :min="minEndDate" :max="maxDate2030" required>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn btn-small" @click="confirmRent">Confirmar Aluguel</button>
                            <button class="btn btn-small btn-secondary" @click="showRentModal = false">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="modal" :class="{ active: showEditAuthorModal }" @click.self="showEditAuthorModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Editar Autor</h3>
                    <button class="modal-close" @click="showEditAuthorModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveEditAuthor">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" v-model="editAuthor.name" required>
                        </div>
                        <div class="form-group">
                            <label>Biografia:</label>
                            <textarea v-model="editAuthor.bio" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Foto (URL ou Cloudinary publicId):</label>
                            <input type="text" v-model="editAuthor.photo">
                            <div class="mt-3">
                                <button type="button" class="btn btn-small" @click="openUpload('author_edit')">Upload</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
                
                <div class="user-info">
                    <span>Ol√°, {{ currentUser.name }}!</span>
                    <div class="user-avatar" @click="showDropdown = !showDropdown">
                        <img :src="thumb(profileFormPhoto || currentUser.photo || 'pedbook/profiles/default-user', 100, 100)" alt="avatar" style="width:100%; height:100%; object-fit:cover;">
                        <div class="user-menu-dropdown" v-if="showDropdown" @click.stop>
                            <button class="dropdown-item" @click="goToPage('books'); showDropdown = false">üìñ Livros</button>
                            <button class="dropdown-item" @click="goToPage('authors'); showDropdown = false">‚úçÔ∏è Autores</button>
                            <button class="dropdown-item" v-if="currentUser" @click="goToPage('users'); showDropdown = false">üë• Usu√°rios</button>
                            <button class="dropdown-item" v-if="currentUser && currentUser.is_admin" @click="goToPage('loans'); showDropdown = false">üìã Empr√©stimos</button>
                            <button class="dropdown-item" @click="goToPage('profile'); showDropdown = false">üë§ Meu Perfil</button>
                            <button class="dropdown-logout" @click="logout">üö™ Sair</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        
        <header v-else>
            <div class="header-container">
                <div class="brand" @click="goHome">
                    <span class="logo">üìö</span>
                    <h1>PedBook</h1>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-small" @click="goToPage('books')">üìñ Livros</button>
                    <button class="btn btn-small" @click="goToPage('authors')">‚úçÔ∏è Autores</button>
                    <button class="btn btn-small" @click="goToPage('login')">üîê Entrar</button>
                </div>
            </div>
        </header>

        
        <div v-if="errorMessage" class="toast toast-error">{{ errorMessage }}</div>

        
        <div v-if="routePage === 'login'" class="login-page">
            <div class="login-box">
                <div v-if="errorMessage" class="error">{{ errorMessage }}</div>

                <div v-if="!showRegister">
                    <h2>Entrar na sua conta</h2>
                    <form @submit.prevent="handleLogin">
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" v-model="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" v-model="loginPassword" required>
                        </div>
                        <button type="submit" class="btn">Entrar</button>
                    </form>
                    <p class="text-center mt-3">N√£o tem conta? <a href="#" @click.prevent="showRegister = true">Criar conta</a></p>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="font-size: 1.1rem; margin-bottom: 10px; color: #162c74;">Credenciais de Teste:</h3>
                        <p style="margin-bottom: 5px;">üë§ Admin: kayky@gmail.com / 123</p>
                        <p>üë§ Usu√°rio: kaue@gmail.com / 123</p>
                    </div>
                </div>

                <div v-else>
                    <h2>Criar Conta</h2>
                    <form @submit.prevent="handleRegister">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" v-model="registerName" required>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" v-model="registerEmail" required>
                        </div>
                        <div class="form-group">
                            <label>Senha:</label>
                            <input type="password" v-model="registerPassword" required>
                        </div>
                        <button type="submit" class="btn">Criar Conta</button>
                    </form>
                    <p class="text-center mt-3">J√° tem conta? <a href="#" @click.prevent="showRegister = false">Entrar</a></p>
                </div>
            </div>
        </div>

        
        <main v-if="routePage !== 'login'">
            
            <div v-if="routePage === 'books'" class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìñ Livros</h2>
                    <button v-if="currentUser && currentUser.is_admin" class="btn btn-small" @click="showCreateBookModal = true">‚ûï Adicionar Livro</button>
                </div>
                <div v-if="!currentUser" style="margin-bottom: 10px;">
                    <button class="btn btn-small btn-secondary" @click="goToLanding">‚Üê Voltar para Home</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 220px 200px; gap:12px; margin-bottom: 12px;">
                    <input type="text" v-model="searchQuery" placeholder="Buscar livros..." style="padding:10px;border:1px solid #dee2e6;border-radius:6px;">
                    <select v-model="authorFilterId" style="padding:10px;border:1px solid #dee2e6;border-radius:6px;">
                        <option value="">Todos autores</option>
                        <option v-for="a in authors" :key="a.id" :value="a.id">{{ a.name }}</option>
                    </select>
                    <select v-model="sortKey" style="padding:10px;border:1px solid #dee2e6;border-radius:6px;">
                        <option value="title">Ordenar: T√≠tulo (A-Z)</option>
                        <option value="recent">Ordenar: Recentes</option>
                    </select>
                </div>
                
                <div v-if="loading">
                    <div class="book-grid">
                        <div v-for="n in 8" :key="n" class="book-card">
                            <div class="skeleton skeleton-card"></div>
                            <div class="book-card-body">
                                <div class="skeleton skeleton-line" style="width:60%;"></div>
                                <div class="skeleton skeleton-line" style="width:40%; height:10px;"></div>
                                <div class="skeleton skeleton-line" style="width:100%; height:8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <p v-if="filteredBooks.length === 0" class="text-center" style="color:#666;">Nenhum livro encontrado.</p>
                    <div class="book-grid">
                        <div v-for="book in paginatedBooks" :key="book.id" class="book-card" :class="{ borrowed: isBookUnavailable(book.id) }" @click="viewBook(book)">
                            <div v-if="isBookUnavailable(book.id)" class="banner-rented">‚úÖ ALUGADO</div>
                            <button v-if="currentUser && !currentUser.is_admin" class="fav-chip" :class="{ active: isFavorite(book.id) }" @click.stop="toggleFavorite(book)" :aria-label="isFavorite(book.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'" :title="isFavorite(book.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">‚ù§</button>
                            <img :src="thumb(book.photo, 600, 360)" :alt="book.title" referrerpolicy="no-referrer" crossorigin="anonymous" loading="lazy">
                            <div class="book-card-body">
                                <h3 class="book-title">{{ book.title }}</h3>
                                <p class="book-author">
                                    <span v-if="book.author" @click.stop="selectAuthor(book.author)" style="cursor:pointer;color:#162c74;text-decoration:underline;">
                                        {{ book.author.name }}
                                    </span>
                                    <span v-else>Autor Desconhecido</span>
                                </p>
                                <p class="book-desc">{{ book.description || 'Sem descri√ß√£o dispon√≠vel.' }}</p>
                                <div v-if="currentUser && !currentUser.is_admin" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
                                    <button class="btn btn-small" :disabled="isBookUnavailable(book.id) && !isBookBorrowedByMe(book.id)" @click.stop="isBookBorrowedByMe(book.id) ? promptReturn(book.id) : openRentModal(book)">
                                        {{ isBookBorrowedByMe(book.id) ? 'üîÑ Devolver' : (isBookUnavailable(book.id) ? 'Indispon√≠vel' : 'Alugar') }}
                                    </button>
                                </div>
                                <div v-else style="margin-top: 10px;">
                                    <button v-if="!currentUser" class="btn btn-small" @click.stop="goToPage('login')">üîê Fa√ßa login para alugar</button>
                                    <div v-else-if="currentUser && currentUser.is_admin" style="padding:8px 0; color:#555; font-size:0.9rem;">üë®‚Äçüíº Administradores n√£o podem alugar ou favoritar livros</div>
                                </div>
                                <div v-if="currentUser && currentUser.is_admin" style="margin-top:10px; display:flex; gap:8px;">
                                    <button class="btn btn-small" @click.stop="openEditBook(book)">Editar</button>
                                    <button class="btn btn-small btn-danger" @click.stop="askDelete('book', book.id)">Excluir</button>
                                </div>
                                <div v-if="currentUser && !currentUser.is_admin && isFavorite(book.id)" class="fav-chip-bottom">‚ù§Ô∏è Favorito</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pagination" v-if="totalPages > 1">
                        <button class="page-link" @click="changePage(booksPage - 1)" :disabled="booksPage === 1">Anterior</button>
                        <button v-for="page in totalPages" :key="page" class="page-link" :class="{ active: page === booksPage }" @click="changePage(page)">
                            {{ page }}
                        </button>
                        <button class="page-link" @click="changePage(booksPage + 1)" :disabled="booksPage === totalPages">Pr√≥xima</button>
                    </div>
                </div>
            </div>
            
            
            <div v-if="routePage === 'authors'" class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>‚úçÔ∏è Autores</h2>
                    <button v-if="currentUser && currentUser.is_admin" class="btn btn-small" @click="showCreateAuthorModal = true">‚ûï Adicionar Autor</button>
                </div>
                <div v-if="!currentUser" style="margin-bottom: 10px;">
                    <button class="btn btn-small btn-secondary" @click="goToLanding">‚Üê Voltar para Home</button>
                </div>
                <div v-if="authorsLoading">
                    <div class="book-grid">
                        <div v-for="n in 6" :key="n" class="book-card">
                            <div class="skeleton skeleton-card"></div>
                            <div class="book-card-body">
                                <div class="skeleton skeleton-line" style="width:50%;"></div>
                                <div class="skeleton skeleton-line" style="width:30%; height:10px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <div class="book-grid">
                        <div v-for="author in paginatedAuthors" :key="author.id" class="book-card" style="cursor: pointer;" @click="selectAuthor(author)">
                            <img :src="thumb(author.photo || 'pedbook/profiles/default-user', 400, 400)" :alt="author.name" referrerpolicy="no-referrer" crossorigin="anonymous" loading="lazy">
                            <div class="book-card-body">
                                <h3 class="book-title">{{ author.name }}</h3>
                                <p class="book-author">üìö {{ author.books?.length || 0 }} livros</p>
                                <div v-if="currentUser && currentUser.is_admin" style="margin-top:10px; display:flex; gap:8px;">
                                    <button class="btn btn-small" @click.stop="openEditAuthor(author)">Editar</button>
                                    <button class="btn btn-small btn-danger" @click.stop="askDelete('author', author.id)">Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pagination" v-if="totalAuthorsPages > 1">
                        <button class="page-link" @click="changeAuthorsPage(authorsPage - 1)" :disabled="authorsPage === 1">Anterior</button>
                        <button v-for="page in totalAuthorsPages" :key="page" class="page-link" :class="{ active: page === authorsPage }" @click="changeAuthorsPage(page)">{{ page }}</button>
                        <button class="page-link" @click="changeAuthorsPage(authorsPage + 1)" :disabled="authorsPage === totalAuthorsPages">Pr√≥xima</button>
                    </div>
                </div>
            </div>

            
            <div v-if="routePage === 'users' && currentUser" class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üë• Usu√°rios</h2>
                </div>
                <div v-if="usersLoading" class="text-center">Carregando usu√°rios...</div>
                <div v-else>
                    <div class="user-grid">
                        <div v-for="u in paginatedUsers" :key="u.id" class="user-card" @click="openUserProfile(u)">
                            <div class="user-card-cover">
                                <img :src="thumb(u.photo || 'pedbook/profiles/default-user', 400, 400)" alt="avatar">
                            </div>
                            <div class="user-card-body">
                                <div class="user-name">{{ u.name }}</div>
                                <div class="user-email">{{ u.email }}</div>
                                <div style="display:flex; justify-content: space-between; align-items:center; margin-top:4px;">
                                    <span class="user-role">{{ u.is_admin ? 'Administrador' : 'Usu√°rio' }}</span>
                                    <span style="font-size:0.75rem; color:#888;">Clique para ver perfil completo</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="pagination" v-if="totalUsersPages > 1">
                        <button class="page-link" @click="changeUsersPage(usersPage - 1)" :disabled="usersPage === 1">Anterior</button>
                        <button v-for="page in totalUsersPages" :key="page" class="page-link" :class="{ active: page === usersPage }" @click="changeUsersPage(page)">{{ page }}</button>
                        <button class="page-link" @click="changeUsersPage(usersPage + 1)" :disabled="usersPage === totalUsersPages">Pr√≥xima</button>
                    </div>
                </div>
            </div>

            <div v-if="routePage === 'user-detail' && currentUser && selectedUser" class="container">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px;">
                    <h2>üë§ Perfil do Usu√°rio</h2>
                    <button class="btn btn-small btn-secondary" @click="goToPage('users')" style="width:auto;">‚Üê Voltar para Usu√°rios</button>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; overflow: hidden;">
                            <img v-if="selectedUser.photo" :src="thumb(selectedUser.photo, 100, 100)" alt="avatar" style="width:100%; height:100%; object-fit: cover;">
                            <span v-else>üë§</span>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #162c74;">{{ selectedUser.name }}</h3>
                            <p style="margin: 0; color: #666;">{{ selectedUser.email }}</p>
                            <span style="display: inline-block; margin-top: 5px; padding: 3px 8px; background: #e9ecef; border-radius: 12px; font-size: 0.8rem; color: #495057;">
                                {{ selectedUser.is_admin ? 'Administrador' : 'Usu√°rio' }}
                            </span>
                            <p style="margin: 8px 0 0 0; color:#777; font-size:0.85rem;">
                                {{ selectedUser.is_admin ? 'Conta de administrador do sistema.' : 'Conta de leitor da biblioteca.' }}
                            </p>
                        </div>
                    </div>

                    <div v-if="currentUser && (currentUser.is_admin || (selectedUser && currentUser.id === selectedUser.id))">
                        <h3 style="margin: 20px 0 10px 0; color: #162c74;">Empr√©stimos desse usu√°rio</h3>
                        <div v-if="selectedUserActiveLoans.length > 0">
                            <div v-for="loan in selectedUserActiveLoans" :key="loan.id" style="padding: 15px; border-bottom: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #162c74;">{{ loan.book?.title }}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Emprestado em: {{ formatDate(loan.loan_date) }}</p>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Data de devolu√ß√£o prevista: {{ formatDate(loan.return_date) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else style="color: #666;">Sem empr√©stimos ativos.</p>

                        <h3 style="margin: 20px 0 10px 0; color: #162c74;">Hist√≥rico de empr√©stimos</h3>
                        <div v-if="selectedUserLoans.length > 0">
                            <div v-for="loan in selectedUserLoans" :key="loan.id" style="padding: 15px; border-bottom: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #162c74;">{{ loan.book?.title }}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Emprestado em: {{ formatDate(loan.loan_date) }}</p>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">
                                            <span v-if="!loan.returned_at">Status: Ativo</span>
                                            <span v-else>Status: Devolvido em {{ formatDate(loan.returned_at) }}</span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p v-else style="color: #666;">Este usu√°rio ainda n√£o possui empr√©stimos.</p>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3 style="margin: 0 0 10px 0; color: #162c74;">Livro favorito desse usu√°rio</h3>
                        <div v-if="selectedUserFavoriteBook" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 5px 0; color: #162c74;">{{ selectedUserFavoriteBook.title }}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">por
                                <span v-if="selectedUserFavoriteBook.author" @click="selectAuthor(selectedUserFavoriteBook.author)" style="cursor:pointer;color:#162c74;text-decoration:underline;">
                                    {{ selectedUserFavoriteBook.author?.name }}
                                </span>
                                <span v-else>Autor Desconhecido</span>
                            </p>
                        </div>
                        <p v-else style="color: #666;">Este usu√°rio ainda n√£o tem um livro favorito.</p>
                    </div>
                </div>
            </div>

            
            <div v-if="routePage === 'loans' && currentUser && currentUser.is_admin" class="container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìã Empr√©stimos</h2>
                </div>
                <div v-if="allLoansLoading" class="text-center">Carregando empr√©stimos...</div>
                <div v-else>
                    <div v-if="allLoans.length > 0">
                        <div v-for="l in allLoans" :key="l.id" style="padding: 12px 16px; border-bottom: 1px solid #eee; background: white; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight:600; color:#162c74;">{{ l.book?.title }}</div>
                                    <div style="color:#666; font-size:0.9rem;">
                                        Usu√°rio:
                                        <span v-if="l.user" @click.stop="openUserProfile(l.user)" style="cursor:pointer;color:#162c74;text-decoration:underline;">{{ l.user.name }}</span>
                                        <span v-else>Desconhecido</span>
                                        ‚Ä¢ Em: {{ formatDate(l.loan_date) }} ‚Ä¢ Devolu√ß√£o: {{ formatDate(l.return_date) }}
                                    </div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn btn-small" @click="returnBook(l.id)">Devolver</button>
                                    <button class="btn btn-small btn-danger" @click="deleteLoan(l.id)">Excluir</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p v-else style="color:#666;">Sem empr√©stimos.</p>
                </div>
            </div>

            
            <div v-if="routePage === 'book-detail' && selectedBook" class="container">
                <button class="btn btn-secondary btn-small" @click="goToPage('books')" style="width: auto; margin-bottom: 15px;">‚Üê Voltar</button>
                <div class="detail-container" style="display: grid; grid-template-columns: 300px 1fr; gap: 30px;">
                    <div class="detail-image" style="width: 300px; height: 400px; border-radius: 8px; overflow: hidden;">
                        <img :src="thumb(selectedBook.photo, 600, 800)" :alt="selectedBook.title" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div class="detail-info">
                        <h2 style="margin:0 0 10px 0;">{{ selectedBook.title }}</h2>
                        <p style="color:#666; margin: 5px 0 15px 0;">Autor: <strong style="cursor:pointer;color:#162c74;text-decoration:underline;" @click="selectAuthor(selectedBook.author)">{{ selectedBook.author?.name }}</strong></p>
                        <p style="color:#666; line-height:1.6;">{{ selectedBook.description || 'Sem descri√ß√£o dispon√≠vel.' }}</p>
                        <div style="margin-top:16px; background:#f8f9fa; padding:12px; border-radius:8px;">
                            <h3 style="margin:0 0 10px 0;">Alugar</h3>
                            <div v-if="currentUser && !currentUser.is_admin">
                                <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
                                    <div>
                                        <label style="font-size:0.9rem;color:#555;">Devolu√ß√£o:</label>
                                        <input type="date" v-model="borrowEndDate" :min="minEndDate" :max="maxDate2030" style="padding:6px;border:1px solid #dee2e6;border-radius:6px;">
                                    </div>
                                    <button class="btn btn-small" @click="borrowBook(selectedBook, borrowStartDate, borrowEndDate)" :disabled="isBookUnavailable(selectedBook.id) && !isBookBorrowedByMe(selectedBook.id)" style="width:auto;">
                                        {{ isBookBorrowedByMe(selectedBook.id) ? ' Devolver' : (isBookUnavailable(selectedBook.id) ? 'Indispon√≠vel' : 'Alugar') }}
                                    </button>
                                    <button v-if="isBookBorrowedByMe(selectedBook.id)" class="btn btn-small btn-danger" @click="promptReturn(selectedBook.id)" style="width:auto;">Devolver</button>
                                </div>
                            </div>
                            <div v-else-if="currentUser && currentUser.is_admin" style="padding:8px 0; color:#555; font-size:0.9rem;">üë®‚Äçüíº Administradores n√£o podem alugar ou favoritar livros</div>
                            <div v-else>
                                <button class="btn btn-small" @click="goToPage('login')" style="width:auto;">üîê Fa√ßa login para alugar</button>
                            </div>
                        </div>
                        <div style="margin-top:20px;">
                            <h3 style="margin:0 0 10px 0;">Avalia√ß√µes</h3>
                            <div v-if="reviews.length > 0" style="margin-bottom:8px;color:#555;">‚≠ê M√©dia: {{ averageRating }} ({{ reviews.length }})</div>
                            <div v-if="reviews.length > 0">
                                <div v-for="r in reviews" :key="r.id" class="review-item" style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:8px;">
                                    <div class="review-header" style="display:flex;justify-content:space-between;align-items:center;">
                                        <span class="review-author" style="font-weight:600;color:#162c74;">{{ r.user?.name || 'Usu√°rio' }}</span>
                                        <div style="display:flex;gap:8px;align-items:center;">
                                            <div class="stars" aria-hidden="true">
                                                <span v-for="n in 5" :key="n" class="star" :class="{ active: r.rating >= n }">‚òÖ</span>
                                            </div>
                                            <button v-if="currentUser && r.user?.id === currentUser.id" class="btn btn-small" @click="editReview(r)">Editar</button>
                                            <button v-if="currentUser && r.user?.id === currentUser.id" class="btn btn-small btn-danger" @click="deleteReview(r.id)">Excluir</button>
                                        </div>
                                    </div>
                                    <div class="review-text" style="color:#666;">{{ r.comment || '' }}</div>
                                </div>
                            </div>
                            <p v-else style="color:#666;">Sem avalia√ß√µes.</p>
                            <div v-if="currentUser && !currentUser.is_admin" style="margin-top:10px;">
                                <div class="form-group">
                                    <label>Sua nota:</label>
                                    <div class="stars" @mouseleave="hoverRating = 0">
                                        <span v-for="n in 5" :key="n" class="star" :class="{ active: (hoverRating || myReviewRating) >= n }" @mouseover="hoverRating = n" @click="myReviewRating = n">‚òÖ</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Coment√°rio:</label>
                                    <textarea v-model="myReviewComment" rows="3" style="width:100%;padding:8px;"></textarea>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <button class="btn btn-small" @click="submitReview" style="width:auto;">{{ editingReviewId ? 'Salvar Altera√ß√µes' : 'Enviar Avalia√ß√£o' }}</button>
                                    <button v-if="editingReviewId" class="btn btn-small btn-secondary" @click="cancelEditReview" style="width:auto;">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <div v-if="routePage === 'author-detail' && selectedAuthor" class="container">
                <button class="btn btn-secondary btn-small" @click="goToPage('authors')" style="width: auto; margin-bottom: 15px;">‚Üê Voltar</button>
                <div style="display:grid; grid-template-columns: 240px 1fr; gap: 24px;">
                    <div style="width:240px;height:240px;border-radius:8px;overflow:hidden;background:#f0f0f0;">
                        <img :src="thumb(selectedAuthor.photo || 'pedbook/profiles/default-user', 400, 400)" :alt="selectedAuthor.name" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div>
                        <h2 style="margin:0 0 10px 0;">{{ selectedAuthor.name }}</h2>
                        <p style="color:#666; line-height:1.6;">{{ selectedAuthor.bio || 'Sem biografia.' }}</p>
                        <h3 style="margin:20px 0 10px 0;">Livros</h3>
                        <div class="book-grid">
                            <div v-for="b in (selectedAuthor.books || [])" :key="b.id" class="book-card" :class="{ borrowed: isBookUnavailable(b.id) }" style="cursor:pointer;" @click="viewBook(b)">
                                <div v-if="isBookUnavailable(b.id)" class="banner-rented">‚úÖ ALUGADO</div>
                                <img :src="imgProxy(b.photo) || 'https://res.cloudinary.com/ddfgsoh5g/image/upload/pedbook/books/default-book'" :alt="b.title">
                                <div class="book-card-body">
                                    <div class="book-title">{{ b.title }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div v-if="routePage === 'profile'" class="container">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 12px;">
                    <h2>üë§ Meu Perfil</h2>
                    <button class="btn btn-small" @click="editingProfile = !editingProfile">{{ editingProfile ? 'Fechar Edi√ß√£o' : 'Editar Perfil' }}</button>
                </div>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; overflow: hidden;">
                            <img v-if="profileFormPhoto || currentUser.photo" :src="thumb(profileFormPhoto || currentUser.photo, 100, 100)" alt="avatar" style="width:100%; height:100%; object-fit: cover;">
                            <span v-else>üë§</span>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #162c74;">{{ currentUser.name }}</h3>
                            <p style="margin: 0; color: #666;">{{ currentUser.email }}</p>
                            <span style="display: inline-block; margin-top: 5px; padding: 3px 8px; background: #e9ecef; border-radius: 12px; font-size: 0.8rem; color: #495057;">
                                {{ currentUser.is_admin ? 'Administrador' : 'Usu√°rio' }}
                            </span>
                        </div>
                    </div>

                    <div v-if="editingProfile" style="margin-bottom: 24px;">
                        <h3 style="margin: 0 0 12px 0; color: #162c74;">Editar Perfil</h3>
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" v-model="profileFormName" required>
                        </div>
                        <div class="form-group">
                            <label>Foto (URL ou Cloudinary publicId):</label>
                            <input type="text" v-model="profileFormPhoto">
                            <div class="mt-3">
                                <button type="button" class="btn btn-small" @click="openUpload('profile')">Upload</button>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-small" @click="saveProfile">Salvar</button>
                            <button class="btn btn-small btn-secondary" @click="editingProfile = false">Cancelar</button>
                        </div>
                    </div>

                    <div>
                        <h3 style="margin: 20px 0 10px 0; color: #162c74;">Meus Empr√©stimos</h3>
                        <div v-if="activeUserLoans.length > 0">
                            <div v-for="loan in activeUserLoans" :key="loan.id" style="padding: 15px; border-bottom: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; color: #162c74;">{{ loan.book.title }}</h4>
                                        <p style="margin: 0; color: #666; font-size: 0.9rem;">Emprestado em: {{ formatDate(loan.loan_date) }}</p>
                                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">Data de devolu√ß√£o: {{ formatDate(loan.return_date) }}</p>
                                    </div>
                                    <button class="btn btn-small btn-danger" @click="returnBook(loan.id)">Devolver</button>
                                </div>
                            </div>
                        </div>
                        <p v-else style="color: #666;">Voc√™ n√£o possui empr√©stimos ativos.</p>
                    </div>

                    <div v-if="!currentUser.is_admin" style="margin-top: 30px;">
                        <h3 style="margin: 0 0 10px 0; color: #162c74;">Meu Livro Favorito</h3>
                        <div v-if="userFavoriteBook" style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="margin: 0 0 5px 0; color: #162c74;">{{ userFavoriteBook.title }}</h4>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">por <span v-if="userFavoriteBook.author" @click="selectAuthor(userFavoriteBook.author)" style="cursor:pointer;color:#162c74;text-decoration:underline;">{{ userFavoriteBook.author?.name }}</span><span v-else>Autor Desconhecido</span></p>
                            <button class="btn btn-small btn-secondary" @click="removeFavorite" style="margin-top: 10px;">Remover dos favoritos</button>
                        </div>
                        <p v-else style="color: #666;">Voc√™ ainda n√£o tem um livro favorito.</p>
                    </div>
                    <div v-else style="margin-top: 30px; color: #666; font-size: 0.9rem;">
                        üë®‚Äçüíº Administradores n√£o t√™m livro favorito.
                    </div>
                </div>
            </div>
        </main>
        
        
        <div class="modal" :class="{ active: showRentModal }" @click.self="closeRentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Alugar Livro</h3>
                    <button class="modal-close" @click="closeRentModal">‚úï</button>
                </div>
                <div class="modal-body">
                    <p v-if="rentTargetBook" style="margin-bottom:12px;color:#162c74;font-weight:600;">{{ rentTargetBook.title }}</p>
                    <div class="form-group">
                        <label>Data de devolu√ß√£o:</label>
                        <input type="date" v-model="rentReturnDate" :min="minEndDate" :max="maxDate2030">
                    </div>
                    <div style="display:flex; gap:8px; margin-top: 10px;">
                        <button class="btn btn-primary" @click="confirmRent">Confirmar</button>
                        <button class="btn btn-secondary" @click="closeRentModal">Cancelar</button>
                    </div>
                    <p style="color:#666; font-size:0.9rem; margin-top:8px;">In√≠cio: hoje. Devolu√ß√£o: ap√≥s hoje, at√© 2030-12-31.</p>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025 PedBook - Plataforma de Compartilhamento de Livros</p>
        </footer>
        
        
        <div class="modal" :class="{ active: showCreateBookModal }" @click.self="showCreateBookModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Adicionar Novo Livro</h3>
                    <button class="modal-close" @click="showCreateBookModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="createBook" class="modal-form">
                        <div class="form-group">
                            <label>T√≠tulo:</label>
                            <input type="text" v-model="newBook.title" required>
                        </div>

                        <div class="modal-section">
                            <div class="modal-section-title">Autor do livro</div>
                            <div class="modal-section-helper">Escolha um autor existente ou cadastre um novo para este livro.</div>
                            <div style="margin-bottom: 10px; font-size: 0.9rem; display:flex; flex-wrap:wrap; gap:12px;">
                                <label>
                                    <input type="radio" value="existing" v-model="newBookAuthorMode">
                                    Selecionar autor existente
                                </label>
                                <label>
                                    <input type="radio" value="new" v-model="newBookAuthorMode">
                                    Criar novo autor junto com o livro
                                </label>
                            </div>
                            <div v-if="newBookAuthorMode === 'existing'">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label>Autor existente:</label>
                                    <select v-model="newBook.author_id">
                                        <option value="">Selecione um autor</option>
                                        <option v-for="author in authors" :key="author.id" :value="author.id">{{ author.name }}</option>
                                    </select>
                                </div>
                            </div>
                            <div v-else>
                                <div class="form-group">
                                    <label>Nome do autor:</label>
                                    <input type="text" v-model="newAuthor.name">
                                </div>
                                <div class="form-group">
                                    <label>Biografia do autor:</label>
                                    <textarea v-model="newAuthor.bio" rows="3"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>Foto do autor (URL ou Cloudinary publicId):</label>
                                    <input type="text" v-model="newAuthor.photo" placeholder="ex.: pedbook/profiles/author-nome">
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-small" @click="openUpload('author')">Upload</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal-two-columns">
                            <div class="form-group">
                                <label>Descri√ß√£o:</label>
                                <textarea v-model="newBook.description" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Foto (URL ou Cloudinary publicId):</label>
                                <input type="text" v-model="newBook.photo" placeholder="ex.: pedbook/books/book-life-in-silence">
                                <div class="mt-3">
                                    <button type="button" class="btn btn-small" @click="openUpload('book')">Upload</button>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>

        
        <div class="modal" :class="{ active: showCreateAuthorModal }" @click.self="showCreateAuthorModal = false">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Adicionar Novo Autor</h3>
                    <button class="modal-close" @click="showCreateAuthorModal = false">‚úï</button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="createAuthor">
                        <div class="form-group">
                            <label>Nome:</label>
                            <input type="text" v-model="newAuthor.name" required>
                        </div>
                        <div class="form-group">
                            <label>Biografia:</label>
                            <textarea v-model="newAuthor.bio" rows="4" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Foto (URL ou Cloudinary publicId):</label>
                            <input type="text" v-model="newAuthor.photo" placeholder="ex.: pedbook/profiles/author-nome">
                            <div class="mt-3">
                                <button type="button" class="btn btn-small" @click="openUpload('author')">Upload</button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>

    const isBrowser = typeof window !== 'undefined';
    

    if (!window.Vue) {
        console.error('Erro: Vue.js n√£o foi carregado corretamente!');
        document.body.innerHTML = '<div style="padding: 20px; color: red; font-family: Arial, sans-serif;"><h1>Erro ao carregar o aplicativo</h1><p>O Vue.js n√£o foi carregado corretamente. Por favor, verifique sua conex√£o com a internet e tente novamente.</p></div>';
    }
    
    const { createApp } = Vue;
    

    const app = createApp({
        data() {
            return {

                currentUser: null,
                authToken: '',
                showDropdown: false,
                

                routePage: 'books',
                

                loginEmail: '',
                loginPassword: '',
                registerName: '',
                registerEmail: '',
                registerPassword: '',
                showRegister: false,
                errorMessage: '',
                successMessage: '',
                

                editingProfile: false,
                profileFormName: '',
                profileFormPhoto: '',
                

                books: [],
                loading: false,
                booksPage: 1,
                itemsPerPage: 5,
                totalItems: 0,
                

                authors: [],
                authorsLoading: false,
                authorsPage: 1,
                selectedAuthor: null,
                selectedBook: null,
                borrowStartDate: '',
                borrowEndDate: '',

                reviews: [],
                myReviewRating: 0,
                myReviewComment: '',
                hoverRating: 0,
                editingReviewId: null,

                searchQuery: '',
                authorFilterId: '',
                sortKey: 'title',
                

                userLoans: [],
                

                userFavoriteBook: null,
                

                showCreateBookModal: false,
                showCreateAuthorModal: false,
                showEditBookModal: false,
                showEditAuthorModal: false,
                showConfirmModal: false,
                confirmTitle: '',
                confirmMessage: '',
                confirmTargetType: '',
                confirmTargetId: null,
                

                newBook: {
                    title: '',
                    author_id: '',
                    description: '',
                    photo: ''
                },

                newBookAuthorMode: 'existing',

                editBook: {
                    id: '',
                    title: '',
                    author_id: '',
                    description: '',
                    photo: ''
                },

                newAuthor: {
                    name: '',
                    bio: '',
                    photo: ''
                },

                editAuthor: {
                    id: '',
                    name: '',
                    bio: '',
                    photo: ''
                },
                

                users: [],
                usersLoading: false,
                usersPage: 1,
                selectedUser: null,
                selectedUserLoans: [],
                selectedUserFavoriteBook: null,
                

                allLoans: [],
                allLoansLoading: false,
                

                showRentModal: false,
                rentTargetBook: null,
                rentReturnDate: '',

                activeBookIds: [],

            };
        },
        
        computed: {
            minStartDate() { const t = new Date(); return t.toISOString().slice(0,10); },
            minEndDate() { const t = new Date(); t.setDate(t.getDate()+1); return t.toISOString().slice(0,10); },
            maxDate2030() { return '2030-12-31'; },
            totalPages() {
                return Math.ceil(this.filteredBooks.length / this.itemsPerPage);
            },
            paginatedBooks() {
                const start = (this.booksPage - 1) * this.itemsPerPage;
                return this.filteredBooks.slice(start, start + this.itemsPerPage);
            },
            totalAuthorsPages() {
                return Math.ceil(this.authors.length / this.itemsPerPage) || 1;
            },
            paginatedAuthors() {
                const start = (this.authorsPage - 1) * this.itemsPerPage;
                return this.authors.slice(start, start + this.itemsPerPage);
            },
            totalUsersPages() {
                return Math.ceil(this.users.length / this.itemsPerPage) || 1;
            },
            paginatedUsers() {
                const start = (this.usersPage - 1) * this.itemsPerPage;
                return this.users.slice(start, start + this.itemsPerPage);
            },
            averageRating() {
                if (!this.reviews || this.reviews.length === 0) return '0.0';
                const sum = this.reviews.reduce((s, r) => s + (parseFloat(r.rating) || 0), 0);
                return (sum / this.reviews.length).toFixed(1);
            },
            filteredBooks() {
                let list = Array.isArray(this.books) ? [...this.books] : [];
                const q = (this.searchQuery || '').toLowerCase().trim();
                if (q) {
                    list = list.filter(b => (b.title || '').toLowerCase().includes(q) || (b.author?.name || '').toLowerCase().includes(q));
                }
                if (this.authorFilterId) {
                    const aid = parseInt(this.authorFilterId);
                    list = list.filter(b => b.author?.id === aid);
                }
                if (this.sortKey === 'title') {
                    list.sort((a,b) => (a.title || '').localeCompare(b.title || ''));
                } else if (this.sortKey === 'recent') {
                    list.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                }
                return list;
            },
            activeUserLoans() {
                try {
                    return (this.userLoans || []).filter(l => !l.returned_at);
                } catch { return []; }
            },
            selectedUserActiveLoans() {
                try {
                    return (this.selectedUserLoans || []).filter(l => !l.returned_at);
                } catch { return []; }
            }
        },
        
        methods: {

            authHeaders() {
                return this.authToken ? { 'Authorization': `Bearer ${this.authToken}` } : {};
            },

            imgProxy(url) {
                if (!url) return '';
                try {
                    if (url.startsWith('http')) {
                        if (url.includes('res.cloudinary.com/ddfgsoh5g/')) {
                            return `/api/img?url=${encodeURIComponent(url)}`;
                        }
                        return url;
                    }

                    if (url.startsWith('pedbook/')) {
                        const full = `https://res.cloudinary.com/ddfgsoh5g/image/upload/${url}`;
                        return `/api/img?url=${encodeURIComponent(full)}`;
                    }
                    return url;
                } catch (e) {
                    return url;
                }
            },

            thumb(url, w = 400, h = 300) {
                try {
                    const basePublic = 'https://res.cloudinary.com/ddfgsoh5g/image/upload';
                    const trans = `f_auto,q_auto,c_fill,g_auto,w_${w},h_${h}`;
                    if (!url) {
                        const def = `${basePublic}/${trans}/pedbook/books/default-book`;
                        return `/api/img?url=${encodeURIComponent(def)}`;
                    }
                    if (url.startsWith('http') && url.includes('/image/upload/')) {
                        const after = url.split('/image/upload/')[1];
                        const full = `${basePublic}/${trans}/${after}`;
                        return `/api/img?url=${encodeURIComponent(full)}`;
                    }
                    if (url.startsWith('pedbook/')) {
                        const full = `${basePublic}/${trans}/${url}`;
                        return `/api/img?url=${encodeURIComponent(full)}`;
                    }
                    return this.imgProxy(url);
                } catch (e) { return this.imgProxy(url); }
            },

            formatDate(d) {
                try {
                    if (!d) return '';
                    if (typeof d === 'string' && /^\d{4}-\d{2}-\d{2}/.test(d)) {
                        const [y,m,rest] = d.split('-');
                        const dd = (rest || '').substring(0,2);
                        return `${dd}/${m}/${y}`;
                    }
                    const dt = new Date(d);
                    if (!isNaN(dt)) return dt.toLocaleDateString('pt-BR');
                    return String(d);
                } catch { return String(d || ''); }
            },

            goToPage(page) {

                const restricted = ['users','profile','loans'];
                if (!this.currentUser && restricted.includes(page)) {
                    this.routePage = 'login';
                    if (isBrowser) window.location.hash = 'login';
                    return;
                }
                this.routePage = page;
                if (isBrowser) {
                    window.location.hash = page;
                    window.scrollTo(0, 0);
                }
                if (page === 'users' && this.currentUser) this.loadUsers();
                if (page === 'loans' && this.currentUser && this.currentUser.is_admin) this.loadAllLoans();
            },
            openUserProfile(user) {
                try {
                    if (!this.currentUser || !user) return;

                    if (String(this.currentUser.id) === String(user.id)) {
                        this.editingProfile = true;
                        this.routePage = 'profile';
                        if (isBrowser) {
                            window.location.hash = 'profile';
                            window.scrollTo(0, 0);
                        }
                        return;
                    }

                    this.selectedUser = user;
                    this.selectedUserLoans = [];
                    this.selectedUserFavoriteBook = null;
                } catch (e) {}
                try {
                    fetch(`/api/loans/user/${user.id}`, { headers: this.authHeaders() })
                        .then(res => res.ok ? res.json() : [])
                        .then(list => { this.selectedUserLoans = Array.isArray(list) ? list : []; })
                        .catch(() => {});
                } catch (e) {}
                try {
                    fetch(`/api/favorites/user/${user.id}`, { headers: this.authHeaders() })
                        .then(res => res.ok ? res.json() : null)
                        .then(book => {
                            this.selectedUserFavoriteBook = (book && book.id) ? book : null;
                        })
                        .catch(() => {});
                } catch (e) {}
                this.routePage = 'user-detail';
                if (isBrowser) {
                    window.location.hash = `user/${user.id}`;
                    window.scrollTo(0, 0);
                }
            },
            goHome() {
                if (!this.currentUser) {
                    if (isBrowser) {
                        window.location.href = '/';
                    }
                    return;
                }
                if (this.routePage !== 'books') {
                    this.goToPage('books');
                    return;
                }
                if (confirm('Voc√™ j√° est√° na p√°gina de livros. Deseja recarregar a lista mesmo assim?')) {
                    this.loadBooks();
                    if (isBrowser) {
                        window.scrollTo(0, 0);
                    }
                }
            },
            goToLanding() {
                if (isBrowser) {
                    window.location.href = '/';
                }
            },
            

            async handleLogin() {
                try {
                    this.errorMessage = '';
                    const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: this.loginEmail, password: this.loginPassword })
                    });
                    if (!res.ok) throw new Error('Credenciais inv√°lidas');
                    const data = await res.json();
                    this.currentUser = data.user;
                    this.authToken = data.token || '';
                    if (isBrowser) {
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        if (this.authToken) localStorage.setItem('authToken', this.authToken);
                    }
                    await this.loadUserData();
                    this.goToPage('books');
                    this.loginEmail = '';
                    this.loginPassword = '';
                } catch (error) {
                    console.error('Erro durante o login:', error);
                    this.errorMessage = '‚ùå Email ou senha inv√°lidos';
                }
            },
            
            async handleRegister() {
                try {
                    this.errorMessage = '';
                    const res = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: this.registerName, email: this.registerEmail, password: this.registerPassword })
                    });
                    if (!res.ok) throw new Error('Falha no registro');
                    const data = await res.json();

                    this.currentUser = data.user;
                    this.authToken = data.token || '';
                    if (isBrowser) {
                        localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                        if (this.authToken) localStorage.setItem('authToken', this.authToken);
                    }

                    await this.loadUserData();

                    this.showRegister = false;
                    this.registerName = '';
                    this.registerEmail = '';
                    this.registerPassword = '';
                    this.loginEmail = '';
                    this.loginPassword = '';
                    this.goToPage('books');
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel criar a conta. Tente novamente.';
                }
            },
            logoutAndGoHome() {
                try {
                    if (this.authToken) {
                        fetch('/api/logout', { method: 'POST', headers: this.authHeaders() }).catch(() => {});
                    }
                } catch (e) {}
                this.currentUser = null;
                this.authToken = '';
                if (isBrowser) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('authToken');
                    window.location.replace('/');
                }
            },

            
            logout() {
                if (this.authToken) {
                    fetch('/api/logout', { method: 'POST', headers: this.authHeaders() }).catch(() => {});
                }
                this.currentUser = null;
                this.authToken = '';
                if (isBrowser) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('authToken');
                }
                this.goToPage('login');
            },
            

            async loadBooks() {
                try {
                    this.loading = true;
                    const res = await fetch('/api/books?all=1');
                    if (!res.ok) throw new Error('Falha ao buscar livros');
                    const data = await res.json();
                    this.books = Array.isArray(data) ? data : (Array.isArray(data?.data) ? data.data : []);
                    this.totalItems = this.books.length;
                } catch (error) {
                    console.error('Erro ao carregar livros:', error);
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel carregar os livros. Tente novamente.';
                } finally {
                    this.loading = false;
                }
            },
            
            async viewBook(book) {
                try {
                    if (!book?.author) {
                        const res = await fetch(`/api/books/${book.id}`);
                        if (res.ok) book = await res.json();
                    }
                } catch {}
                this.selectedBook = book;
                this.routePage = 'book-detail';
                if (isBrowser) window.location.hash = `book/${book.id}`;
                try {
                    const today = new Date();
                    this.borrowStartDate = today.toISOString().slice(0,10);
                    const d2 = new Date(today.getTime() + 14 * 24 * 60 * 60 * 1000);
                    this.borrowEndDate = d2.toISOString().slice(0,10);
                } catch {}
                this.loadReviews(book.id);
            },
            openRentModal(book) {
                if (!this.currentUser) { this.errorMessage = 'Fa√ßa login para alugar'; return; }
                this.rentTargetBook = book;
                const t = new Date(); t.setDate(t.getDate()+1);
                this.rentReturnDate = t.toISOString().slice(0,10);
                this.showRentModal = true;
            },
            closeRentModal() { this.showRentModal = false; this.rentTargetBook = null; },
            async confirmRent() {
                try {
                    if (!this.rentTargetBook) return;
                    if (!this.rentReturnDate) { this.errorMessage = 'Selecione a data de devolu√ß√£o.'; return; }
                    await this.borrowBook(this.rentTargetBook, undefined, this.rentReturnDate);
                    this.closeRentModal();
                } catch (e) { this.errorMessage = 'N√£o foi poss√≠vel alugar.'; }
            },


            
            async borrowBook(book, startDate, endDate) {
                try {
                    if (!this.currentUser) {
                        this.errorMessage = 'Fa√ßa login para alugar';
                        return;
                    }
                    if (this.currentUser?.is_admin) {
                        this.errorMessage = 'üë®‚Äçüíº Administradores n√£o podem alugar livros';
                        return;
                    }
                    if (this.isBookUnavailable(book.id) && !this.isBookBorrowedByMe(book.id)) {
                        this.errorMessage = 'üìö Livro indispon√≠vel no momento.';
                        return;
                    }
                    const sd = (typeof startDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(startDate)) ? startDate : new Date().toISOString().slice(0,10);
                const ed = (typeof endDate === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(endDate)) ? endDate : new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().slice(0,10);
                const todayStr = new Date().toISOString().slice(0,10);
                const maxStr = '2030-12-31';
                if (sd < todayStr) { this.errorMessage = 'Data de in√≠cio deve ser hoje ou posterior.'; return; }
                if (ed <= todayStr) { this.errorMessage = 'Data de devolu√ß√£o deve ser ap√≥s hoje.'; return; }
                if (ed <= sd) { this.errorMessage = 'Data de devolu√ß√£o deve ser ap√≥s a data de in√≠cio.'; return; }
                if (ed > maxStr) { this.errorMessage = 'Data de devolu√ß√£o deve ser at√© 2030-12-31.'; return; }
                    if (this.isBookBorrowedByMe(book.id)) {
                        alert('Voc√™ j√° alugou este livro!');
                        return;
                    }
                    const loan_date = new Date();
                    const return_date = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000);
                    const res = await fetch('/api/loans', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify({ user_id: this.currentUser.id, book_id: book.id, loan_date: sd, return_date: ed })
                    });
                    if (!res.ok) throw new Error('Falha ao criar empr√©stimo');

                    await this.loadUserData();
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel alugar o livro.';
                }
            },
            
            userLoanForBook(bookId) { try { return (this.userLoans||[]).find(l => l.book.id === bookId && !l.returned_at) || null; } catch { return null; } },

            async returnBook(loanId) {
                try {
                    const res = await fetch(`/api/loans/${loanId}/return`, { method: 'PUT', headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao devolver');
                    if (this.routePage === 'loans' && this.currentUser?.is_admin) {
                        await this.loadAllLoans();
                        await this.loadUserData();
                    } else {
                        await this.loadUserData();
                    }
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel devolver o livro.';
                }
            },
            promptReturn(bookId) {
                try {
                    const l = this.userLoanForBook(bookId);
                    if (!l) return;
                    if (confirm('Deseja devolver este livro?')) {
                        this.returnBook(l.id);
                    }
                } catch (e) {}
            },
            
            isBookBorrowed(bookId) {
                return (this.userLoans || []).some(loan => loan.book.id === bookId && !loan.returned_at);
            },
            
            isBookBorrowedByMe(bookId) {
                try {
                    return (this.userLoans || []).some(l => l.book.id === bookId && !l.returned_at);
                } catch (e) { return false; }
            },
            isBookUnavailable(bookId) {
                try {
                    const id = typeof bookId === 'string' ? parseInt(bookId) : bookId;
                    return Array.isArray(this.activeBookIds) && this.activeBookIds.includes(id);
                } catch (e) { return false; }
            },


            async toggleFavorite(book) {
                if (!this.currentUser) {
                    this.errorMessage = 'Fa√ßa login para favoritar';
                    return;
                }
                if (this.currentUser?.is_admin) {
                    this.errorMessage = 'üë®‚Äçüíº Administradores n√£o podem favoritar livros';
                    return;
                }
                try {
                    if (this.isFavorite(book.id)) {
                        const del = await fetch(`/api/favorites/user/${this.currentUser.id}`, { method: 'DELETE', headers: this.authHeaders() });
                        if (!del.ok) throw new Error('Falha ao remover favorito');
                        this.userFavoriteBook = null;
                    } else {
                        const res = await fetch('/api/favorites', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                            body: JSON.stringify({ user_id: this.currentUser.id, book_id: book.id })
                        });
                        if (!res.ok) throw new Error('Falha ao salvar favorito');
                        this.userFavoriteBook = await res.json();
                    }
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel atualizar favorito.';
                }
            },
            
            async removeFavorite() {
                if (!this.currentUser || !this.userFavoriteBook) return;
                try {
                    const del = await fetch(`/api/favorites/user/${this.currentUser.id}`, { method: 'DELETE', headers: this.authHeaders() });
                    if (!del.ok) throw new Error('Falha ao remover');
                    this.userFavoriteBook = null;
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel remover dos favoritos.';
                }
            },
            
            isFavorite(bookId) {
                return this.userFavoriteBook && this.userFavoriteBook.id === bookId;
            },
            

            async loadAuthors() {
                try {
                    this.authorsLoading = true;
                    const res = await fetch('/api/authors');
                    if (!res.ok) throw new Error('Falha ao buscar autores');
                    const data = await res.json();
                    this.authors = Array.isArray(data) ? data : [];
                } catch (e) {
                    this.authors = [];
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel carregar autores. Tente novamente.';
                } finally {
                    this.authorsLoading = false;
                }
            },
            async selectAuthor(author) {
                try {
                    if (!author?.books || author.books.length === 0) {
                        const res = await fetch(`/api/authors/${author.id}`);
                        if (res.ok) author = await res.json();
                    }
                } catch {}
                this.selectedAuthor = author;
                this.routePage = 'author-detail';
                if (isBrowser) window.location.hash = `author/${author.id}`;
            },
            

            async createBook() {
                try {
                    const payload = {
                        title: this.newBook.title,
                        description: this.newBook.description || '',
                        photo: this.newBook.photo || ''
                    };

                    if (this.newBookAuthorMode === 'existing') {
                        if (!this.newBook.author_id) {
                            this.errorMessage = 'Selecione um autor para o livro.';
                            return;
                        }
                        payload.author_id = parseInt(this.newBook.author_id);
                    } else {
                        if (!this.newAuthor.name) {
                            this.errorMessage = 'Informe o nome do novo autor.';
                            return;
                        }
                        payload.author_name = this.newAuthor.name;
                        payload.author_bio = this.newAuthor.bio || '';
                        payload.author_photo = this.newAuthor.photo || '';
                    }

                    const res = await fetch('/api/books', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Falha ao criar livro');
                    await this.loadBooks();
                    await this.loadAuthors();
                    this.showCreateBookModal = false;
                    this.newBook = { title: '', author_id: '', description: '', photo: '' };
                    this.newBookAuthorMode = 'existing';
                    this.newAuthor = { name: '', bio: '', photo: '' };
                } catch (error) {
                    console.error('Erro ao criar livro:', error);
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel adicionar o livro. Tente novamente.';
                }
            },
            

            async createAuthor() {
                try {
                    const payload = { name: this.newAuthor.name, bio: this.newAuthor.bio || '', photo: this.newAuthor.photo || '' };
                    const res = await fetch('/api/authors', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Falha ao criar autor');
                    await this.loadAuthors();
                    this.showCreateAuthorModal = false;
                    this.newAuthor = { name: '', bio: '', photo: '' };
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel adicionar o autor.';
                }
            },
            

            openUpload(target) {
                try {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';

                    input.onchange = async (e) => {
                        const file = e.target.files && e.target.files[0];
                        if (!file) return;

                        const isBook = target === 'book' || target === 'book_edit';
                        const isAuthor = target === 'author' || target === 'author_edit';
                        const isProfile = target === 'profile';
                        const folder = isBook ? 'pedbook/books' : 'pedbook/profiles';

                        const form = new FormData();
                        form.append('file', file);
                        form.append('upload_preset', 'pedbook_unsigned');
                        form.append('folder', folder);

                        try {
                            const res = await fetch('https://api.cloudinary.com/v1_1/ddfgsoh5g/image/upload', {
                                method: 'POST',
                                body: form
                            });
                            let data = null;
                            try {
                                data = await res.json();
                            } catch (_) {}
                            if (!res.ok) {
                                const msg = data && data.error && data.error.message ? data.error.message : `HTTP ${res.status}`;
                                alert('Erro ao enviar imagem: ' + msg);
                                return;
                            }
                            const publicId = data && data.public_id ? data.public_id : '';
                            if (!publicId) return;

                            if (target === 'book') this.newBook.photo = publicId;
                            if (target === 'author') this.newAuthor.photo = publicId;
                            if (target === 'book_edit') this.editBook.photo = publicId;
                            if (target === 'author_edit') this.editAuthor.photo = publicId;
                            if (isProfile || target === 'profile') {
                                this.profileFormPhoto = publicId;
                                if (this.currentUser) {
                                    await this.saveProfile();
                                }
                            }
                        } catch (err) {
                            console.error('cloudinary upload error', err);
                            alert('N√£o foi poss√≠vel enviar a imagem.');
                        }
                    };

                    input.click();
                } catch (e) {
                    console.error('openUpload error', e);
                    alert('N√£o foi poss√≠vel abrir o seletor de arquivo.');
                }
            },

            async saveProfile() {
                try {
                    if (!this.currentUser) return;
                    const payload = {
                        name: this.profileFormName,
                        photo: this.profileFormPhoto || (this.currentUser && this.currentUser.photo) || ''
                    };
                    const res = await fetch(`/api/users/${this.currentUser.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Falha ao salvar perfil');
                    const updated = await res.json();
                    this.currentUser = updated;
                    if (isBrowser) localStorage.setItem('currentUser', JSON.stringify(updated));
                    this.editingProfile = false;
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel salvar o perfil.';
                }
            },

            askDelete(type, id) {
                if (!confirm('Tem certeza que deseja excluir?')) return;
                if (type === 'book') return this.deleteBook(id);
                if (type === 'author') return this.deleteAuthor(id);
                if (type === 'loan') return this.deleteLoan(id);
            },


            openEditBook(book) {
                this.editBook = {
                    id: book.id,
                    title: book.title,
                    author_id: book.author?.id || '',
                    description: book.description || '',
                    photo: book.photo || ''
                };
                this.showEditBookModal = true;
            },
            async saveEditBook() {
                try {
                    const payload = {
                        title: this.editBook.title,
                        description: this.editBook.description,
                        author_id: parseInt(this.editBook.author_id),
                        photo: this.editBook.photo
                    };
                    const res = await fetch(`/api/books/${this.editBook.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Falha ao atualizar livro');
                    this.showEditBookModal = false;
                    await this.loadBooks();
                    if (this.selectedBook && this.selectedBook.id === this.editBook.id) {
                        const b = await (await fetch(`/api/books/${this.editBook.id}`)).json();
                        this.selectedBook = b;
                    }
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel atualizar o livro.';
                }
            },
            async deleteBook(id) {
                try {
                    const res = await fetch(`/api/books/${id}`, { method: 'DELETE', headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao excluir livro');
                    await this.loadBooks();
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel excluir o livro.';
                }
            },


            openEditAuthor(author) {
                this.editAuthor = {
                    id: author.id,
                    name: author.name,
                    bio: author.bio || '',
                    photo: author.photo || ''
                };
                this.showEditAuthorModal = true;
            },
            async saveEditAuthor() {
                try {
                    const payload = { name: this.editAuthor.name, bio: this.editAuthor.bio, photo: this.editAuthor.photo };
                    const res = await fetch(`/api/authors/${this.editAuthor.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error('Falha ao atualizar autor');
                    this.showEditAuthorModal = false;
                    await this.loadAuthors();
                    if (this.selectedAuthor && this.selectedAuthor.id === this.editAuthor.id) {
                        const a = await (await fetch(`/api/authors/${this.editAuthor.id}`)).json();
                        this.selectedAuthor = a;
                    }
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel atualizar o autor.';
                }
            },
            async deleteAuthor(id) {
                try {
                    const res = await fetch(`/api/authors/${id}`, { method: 'DELETE', headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao excluir autor');
                    await this.loadAuthors();
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel excluir o autor.';
                }
            },
            

            async loadUsers() {
                try {
                    this.usersLoading = true;
                    const res = await fetch('/api/users?per_page=100', { headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao buscar usu√°rios');
                    const ud = await res.json();
                    this.users = Array.isArray(ud) ? ud : (Array.isArray(ud?.data) ? ud.data : []);
                } catch (e) {
                    this.users = [];
                } finally {
                    this.usersLoading = false;
                }
            },
            changeUsersPage(page) {
                if (page >= 1 && page <= this.totalUsersPages) {
                    this.usersPage = page;
                    if (isBrowser) window.scrollTo(0, 0);
                }
            },
            changeAuthorsPage(page) {
                if (page >= 1 && page <= this.totalAuthorsPages) {
                    this.authorsPage = page;
                    if (isBrowser) window.scrollTo(0, 0);
                }
            },


            changePage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.booksPage = page;
                    if (isBrowser) {
                        window.scrollTo(0, 0);
                    }
                }
            },


            async loadAllLoans() {
                try {
                    this.allLoansLoading = true;
                    const res = await fetch('/api/loans', { headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao buscar empr√©stimos');
                    this.allLoans = await res.json();
                } catch (e) {
                    this.allLoans = [];
                } finally {
                    this.allLoansLoading = false;
                }
            },
            async deleteLoan(id) {
                try {
                    const res = await fetch(`/api/loans/${id}`, { method: 'DELETE', headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao excluir');
                    await this.loadAllLoans();
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel excluir o empr√©stimo.';
                }
            },


            async loadReviews(bookId) {
                try {
                    const res = await fetch(`/api/reviews/book/${bookId}`);
                    if (res.ok) {
                        this.reviews = await res.json();
                    } else {
                        this.reviews = [];
                    }
                } catch (e) {
                    this.reviews = [];
                }
            },
            async submitReview() {
                if (!this.currentUser || !this.selectedBook) return;
                try {
                    const payload = { user_id: this.currentUser.id, book_id: this.selectedBook.id, rating: this.myReviewRating, comment: this.myReviewComment };
                    const res = await fetch('/api/reviews', { method: 'POST', headers: { 'Content-Type': 'application/json', ...this.authHeaders() }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error('Erro ao salvar review');
                    this.myReviewRating = 0; this.myReviewComment = ''; this.hoverRating = 0; this.editingReviewId = null;
                    await this.loadReviews(this.selectedBook.id);
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel salvar sua avalia√ß√£o.';
                }
            },
            editReview(r) {
                this.editingReviewId = r.id;
                this.myReviewRating = Number(r.rating) || 0;
                this.myReviewComment = r.comment || '';
                if (isBrowser) window.scrollTo(0, document.body.scrollHeight);
            },
            cancelEditReview() {
                this.editingReviewId = null;
                this.myReviewRating = 0;
                this.myReviewComment = '';
                this.hoverRating = 0;
            },
            async deleteReview(id) {
                try {
                    const res = await fetch(`/api/reviews/${id}`, { method: 'DELETE', headers: this.authHeaders() });
                    if (!res.ok) throw new Error('Falha ao excluir review');
                    await this.loadReviews(this.selectedBook.id);
                } catch (e) {
                    this.errorMessage = '‚ùå N√£o foi poss√≠vel excluir a avalia√ß√£o.';
                }
            },


            async loadUserData() {
                if (!this.currentUser) return;
                try {
                    const loansRes = await fetch(`/api/loans/user/${this.currentUser.id}`, { headers: this.authHeaders() });
                    if (loansRes.ok) this.userLoans = await loansRes.json(); else this.userLoans = [];
                } catch (e) { this.userLoans = []; }
                try {
                    const favRes = await fetch(`/api/favorites/user/${this.currentUser.id}`, { headers: this.authHeaders() });
                    if (favRes.ok) {
                        const fav = await favRes.json();
                        this.userFavoriteBook = (fav && fav.id) ? fav : null;
                    } else {
                        this.userFavoriteBook = null;
                    }
                } catch (e) { this.userFavoriteBook = null; }
                try {
                    const availRes = await fetch('/api/loans/active-book-ids', { headers: this.authHeaders() });
                    if (availRes.ok) this.activeBookIds = await availRes.json(); else this.activeBookIds = [];
                } catch (e) { this.activeBookIds = []; }
            },

            async handleRouteHash(h) {
                const hash = (h || (window.location.hash ? window.location.hash.substring(1) : '')).replace(/^#/, '');
                if (!hash) return;

                const restricted = ['users','profile','loans'];
                if (!this.currentUser && restricted.includes(hash)) {
                    this.routePage = 'login';
                    if (isBrowser) window.location.hash = 'login';
                    return;
                }
                if (['books','authors','users','profile','login','loans'].includes(hash)) {
                    this.routePage = hash;
                    if (hash === 'users' && this.currentUser) this.loadUsers();
                    if (hash === 'loans' && this.currentUser && this.currentUser.is_admin) this.loadAllLoans();
                    return;
                }
                if (hash.startsWith('user/')) {
                    const id = parseInt(hash.split('/')[1]);
                    if (id && this.currentUser) {
                        if (!Array.isArray(this.users) || this.users.length === 0) {
                            await this.loadUsers();
                        }
                        const u = (this.users || []).find(x => x.id === id);
                        if (u) {
                            this.openUserProfile(u);
                        }
                    }
                    return;
                }
                if (hash.startsWith('book/')) {
                    const id = parseInt(hash.split('/')[1]);
                    if (id) {
                        try {
                            const res = await fetch(`/api/books/${id}`);
                            if (res.ok) {
                                const b = await res.json();
                                this.viewBook(b);
                            }
                        } catch {}
                    }
                    return;
                }
                if (hash.startsWith('author/')) {
                    const id = parseInt(hash.split('/')[1]);
                    if (id) {
                        try {
                            const res = await fetch(`/api/authors/${id}`);
                            if (res.ok) {
                                const a = await res.json();
                                this.selectAuthor(a);
                            }
                        } catch {}
                    }
                }
            },
        },
        watch: {
            searchQuery() { this.booksPage = 1; },
            authorFilterId() { this.booksPage = 1; },
            sortKey() { this.booksPage = 1; },
            routePage(val) {
                if (val === 'profile' && this.currentUser) {
                    this.profileFormName = this.currentUser.name || '';
                    this.profileFormPhoto = this.currentUser.photo || '';
                }
            },
            currentUser(val) {
                if (val) {
                    this.profileFormName = val.name || '';
                    this.profileFormPhoto = val.photo || '';
                }
            }
        },
        
        mounted: async function () {
            if (isBrowser) {
                await this.loadBooks();
                this.loadAuthors();

                const hash = window.location.hash ? window.location.hash.substring(1) : '';
                const path = window.location.pathname;
                if (hash) {
                    await this.handleRouteHash(hash);
                } else {
                    if (path === '/login') {
                        this.routePage = 'login';
                        window.location.hash = 'login';
                    } else if (path === '/register') {
                        this.routePage = 'login';
                        this.showRegister = true;
                        window.location.hash = 'login';
                    } else {
                        this.goToPage('books');
                    }
                }

                window.addEventListener('hashchange', () => this.handleRouteHash());
            }
        }
    });
    

    app.mount('#app');
    </script>
</body>
</html>
